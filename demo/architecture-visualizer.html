<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lorebook Architecture Visualizer</title>
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: #1a1a2e;
      color: #eee;
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 320px;
      background: #16213e;
      padding: 20px;
      overflow-y: auto;
      border-right: 1px solid #0f3460;
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .graph-container {
      flex: 1;
      background: #0f0f23;
      height: calc(100vh - 200px);
      min-height: 400px;
    }

    .info-panel {
      height: 200px;
      background: #16213e;
      padding: 15px;
      overflow-y: auto;
      border-top: 1px solid #0f3460;
    }

    h1 { font-size: 1.3em; margin-bottom: 15px; color: #e94560; }
    h2 { font-size: 1.1em; margin: 15px 0 10px; color: #0f3460; border-bottom: 1px solid #0f3460; padding-bottom: 5px; color: #53a8b6; }
    h3 { font-size: 0.95em; color: #e94560; margin-bottom: 8px; }

    .controls { margin-bottom: 20px; }

    .btn {
      display: block;
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      background: #0f3460;
      border: none;
      color: #eee;
      cursor: pointer;
      border-radius: 4px;
      text-align: left;
      font-size: 0.9em;
      transition: background 0.2s;
    }
    .btn:hover { background: #1a4a7a; }
    .btn.active { background: #e94560; }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 10px 0;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.8em;
    }
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .info-panel p { margin: 5px 0; font-size: 0.9em; line-height: 1.5; }
    .info-panel code {
      background: #0f3460;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.85em;
    }

    .fact-list {
      font-size: 0.85em;
      margin: 10px 0;
    }
    .fact {
      background: #0f3460;
      padding: 8px;
      margin: 4px 0;
      border-radius: 4px;
      border-left: 3px solid #53a8b6;
    }
    .fact.hidden {
      opacity: 0.4;
      border-left-color: #e94560;
    }
    .fact-label {
      color: #888;
      font-size: 0.8em;
    }

    .pov-selector {
      background: #0f3460;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .pov-selector select {
      width: 100%;
      padding: 8px;
      background: #1a1a2e;
      color: #eee;
      border: 1px solid #53a8b6;
      border-radius: 4px;
    }

    .cascade-step {
      background: #0f3460;
      padding: 10px;
      margin: 8px 0;
      border-radius: 4px;
      border-left: 3px solid #ffc107;
    }
    .cascade-step.committed {
      border-left-color: #28a745;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h1>Lorebook Architecture</h1>

    <div class="controls">
      <h2>Views</h2>
      <button class="btn active" onclick="showView('world')">World Graph</button>
      <button class="btn" onclick="showView('scene')">Scene: Reacher meets Aradia</button>
      <button class="btn" onclick="showView('pov')">POV Knowledge Filtering</button>
      <button class="btn" onclick="showView('cascade')">Effect Cascade: River Poison</button>
    </div>

    <div class="legend">
      <div class="legend-item"><div class="legend-dot" style="background: #e94560"></div> Character</div>
      <div class="legend-item"><div class="legend-dot" style="background: #53a8b6"></div> Place</div>
      <div class="legend-item"><div class="legend-dot" style="background: #ffc107"></div> Event</div>
      <div class="legend-item"><div class="legend-dot" style="background: #28a745"></div> Group</div>
    </div>

    <div id="view-controls"></div>
  </div>

  <div class="main">
    <div id="graph" class="graph-container"></div>
    <div id="info" class="info-panel">
      <h3>Select a node or view</h3>
      <p>Click on nodes to see details. Use the view buttons to explore different aspects of the architecture.</p>
    </div>
  </div>

  <script>
    const colors = {
      character: '#e94560',
      place: '#53a8b6',
      event: '#ffc107',
      group: '#28a745',
      relationship: '#666',
      knowledge: '#9b59b6',
      effect: '#ff6b35'
    };

    const worldData = {
      nodes: [
        { id: 'sunnaria', label: 'Sunnaria\n(Kingdom)', group: 'place', title: 'The central kingdom' },
        { id: 'verath', label: 'Verath\n(Kingdom)', group: 'place', title: 'Upstream kingdom' },
        { id: 'kalmoor', label: 'Kalmoor\n(Kingdom)', group: 'place', title: 'Downstream kingdom' },
        { id: 'river', label: 'River Verath', group: 'place', shape: 'diamond', title: 'Major river flowing through all three kingdoms' },
        { id: 'palace', label: 'Royal Palace', group: 'place', title: 'Sunnaria\'s palace' },

        { id: 'elara', label: 'Queen Elara', group: 'character', title: 'Ruler of Sunnaria' },
        { id: 'aradia', label: 'Princess Aradia', group: 'character', title: 'Daughter of Elara' },
        { id: 'reacher', label: 'Reacher', group: 'character', title: 'Newly appointed bodyguard' },
        { id: 'mage', label: 'Evil Mage', group: 'character', title: 'Antagonist' },

        { id: 'council', label: 'War Council', group: 'group', shape: 'box', title: 'Secret advisory group' },
      ],
      edges: [
        { from: 'elara', to: 'sunnaria', label: 'rules', arrows: 'to' },
        { from: 'aradia', to: 'elara', label: 'daughter-of', arrows: 'to' },
        { from: 'reacher', to: 'aradia', label: 'bodyguard-of', arrows: 'to', dashes: true },
        { from: 'elara', to: 'reacher', label: 'appointed', arrows: 'to' },
        { from: 'palace', to: 'sunnaria', label: 'in', arrows: 'to' },

        { from: 'river', to: 'verath', label: 'flows through', arrows: 'to' },
        { from: 'river', to: 'sunnaria', label: 'flows through', arrows: 'to' },
        { from: 'river', to: 'kalmoor', label: 'flows through', arrows: 'to' },

        { from: 'elara', to: 'council', label: 'member-of', arrows: 'to' },
        { from: 'verath', to: 'sunnaria', label: 'borders' },
        { from: 'sunnaria', to: 'kalmoor', label: 'borders' },
      ]
    };

    const sceneData = {
      nodes: [
        { id: 'event1', label: 'Scene:\nReacher meets Aradia', group: 'event', shape: 'box',
          title: 'First meeting between bodyguard and princess' },
        { id: 'aradia', label: 'Princess Aradia', group: 'character' },
        { id: 'reacher', label: 'Reacher', group: 'character' },
        { id: 'elara', label: 'Queen Elara', group: 'character', opacity: 0.4 },
        { id: 'palace', label: 'Royal Palace', group: 'place' },

        { id: 'fact1', label: 'Aradia dislikes\nbeing "treated\nlike a child"', group: 'event', shape: 'box', font: { size: 10 } },
        { id: 'fact2', label: 'Aradia\'s demeanor:\nnonchalant', group: 'event', shape: 'box', font: { size: 10 } },
        { id: 'fact3', label: 'Reacher addressed\nAradia formally', group: 'event', shape: 'box', font: { size: 10 } },
      ],
      edges: [
        { from: 'event1', to: 'aradia', label: 'participant', arrows: 'to', color: colors.character },
        { from: 'event1', to: 'reacher', label: 'participant', arrows: 'to', color: colors.character },
        { from: 'event1', to: 'palace', label: 'location', arrows: 'to', color: colors.place },
        { from: 'event1', to: 'elara', label: 'NOT present', arrows: 'to', dashes: true, color: '#e94560' },

        { from: 'event1', to: 'fact1', label: 'extracted', arrows: 'to', dashes: true },
        { from: 'event1', to: 'fact2', label: 'extracted', arrows: 'to', dashes: true },
        { from: 'event1', to: 'fact3', label: 'extracted', arrows: 'to', dashes: true },
      ]
    };

    let currentPOV = 'reacher';

    const povData = {
      characters: ['reacher', 'elara', 'aradia'],
      facts: [
        { id: 'f1', text: 'Aradia is Princess of Sunnaria', knownBy: ['reacher', 'elara', 'aradia'], type: 'public' },
        { id: 'f2', text: 'Elara appointed Reacher as bodyguard', knownBy: ['reacher', 'elara', 'aradia'], type: 'public' },
        { id: 'f3', text: 'Aradia dislikes being "treated like a child"', knownBy: ['reacher', 'aradia'], type: 'scene' },
        { id: 'f4', text: 'Aradia\'s demeanor was nonchalant', knownBy: ['reacher', 'aradia'], type: 'scene' },
        { id: 'f5', text: 'War council discussed border tensions', knownBy: ['elara'], type: 'private' },
        { id: 'f6', text: 'Elara worries about Aradia\'s safety', knownBy: ['elara'], type: 'private' },
        { id: 'f7', text: 'Reacher\'s combat training background', knownBy: ['reacher', 'elara'], type: 'semi-public' },
        { id: 'f8', text: 'Aradia has a secret correspondence', knownBy: ['aradia'], type: 'private' },
      ]
    };

    const cascadeData = {
      stages: [
        {
          name: 'Trigger Event',
          nodes: [
            { id: 'poison', label: 'Evil Mage\npoisons River', group: 'event', shape: 'box' },
            { id: 'mage', label: 'Evil Mage', group: 'character' },
            { id: 'river', label: 'River Verath', group: 'place', shape: 'diamond' },
          ],
          edges: [
            { from: 'mage', to: 'poison', label: 'causes', arrows: 'to' },
            { from: 'poison', to: 'river', label: 'affects', arrows: 'to' },
          ]
        },
        {
          name: 'System Identifies Affected Entities',
          nodes: [
            { id: 'poison', label: 'River Poisoned', group: 'event', shape: 'box' },
            { id: 'river', label: 'River Verath', group: 'place', shape: 'diamond' },
            { id: 'verath', label: 'Verath\n(upstream)', group: 'place' },
            { id: 'sunnaria', label: 'Sunnaria\n(midstream)', group: 'place' },
            { id: 'kalmoor', label: 'Kalmoor\n(downstream)', group: 'place' },
          ],
          edges: [
            { from: 'poison', to: 'river', arrows: 'to' },
            { from: 'river', to: 'verath', label: '1st', arrows: 'to', color: '#ff6b35' },
            { from: 'river', to: 'sunnaria', label: '2nd', arrows: 'to', color: '#ff6b35' },
            { from: 'river', to: 'kalmoor', label: '3rd', arrows: 'to', color: '#ff6b35' },
          ]
        },
        {
          name: 'Generated Possibilities (Author Picks)',
          nodes: [
            { id: 'poison', label: 'River Poisoned', group: 'event', shape: 'box' },
            { id: 'branchA', label: 'Branch A:\nUnchecked Spread', group: 'event', shape: 'box', color: { background: '#28a745', border: '#28a745' } },
            { id: 'branchB', label: 'Branch B:\nSunnaria Contains', group: 'event', shape: 'box', opacity: 0.4 },
            { id: 'branchC', label: 'Branch C:\nPoison Fails', group: 'event', shape: 'box', opacity: 0.4 },
          ],
          edges: [
            { from: 'poison', to: 'branchA', label: '50%', arrows: 'to' },
            { from: 'poison', to: 'branchB', label: '30%', arrows: 'to', dashes: true },
            { from: 'poison', to: 'branchC', label: '20%', arrows: 'to', dashes: true },
          ]
        },
        {
          name: 'Effects Committed as Facts',
          nodes: [
            { id: 'branchA', label: 'Branch A\n(SELECTED)', group: 'event', shape: 'box', color: { background: '#28a745' } },
            { id: 'verath', label: 'Verath', group: 'place' },
            { id: 'sunnaria', label: 'Sunnaria', group: 'place' },
            { id: 'kalmoor', label: 'Kalmoor', group: 'place' },
            { id: 'e1', label: 'Health Crisis\n(severe)', group: 'effect', shape: 'box', color: { background: '#ff6b35' } },
            { id: 'e2', label: 'Health Crisis\n(moderate)', group: 'effect', shape: 'box', color: { background: '#ff6b35' } },
            { id: 'e3', label: 'Health Crisis\n(minor)', group: 'effect', shape: 'box', color: { background: '#ff6b35' } },
            { id: 'e4', label: 'Economic\nCollapse', group: 'effect', shape: 'box', color: { background: '#ff6b35' } },
            { id: 'e5', label: 'Refugee\nCrisis', group: 'effect', shape: 'box', color: { background: '#ff6b35' } },
          ],
          edges: [
            { from: 'branchA', to: 'e1', arrows: 'to' },
            { from: 'branchA', to: 'e2', arrows: 'to' },
            { from: 'branchA', to: 'e3', arrows: 'to' },
            { from: 'e1', to: 'verath', arrows: 'to' },
            { from: 'e2', to: 'sunnaria', arrows: 'to' },
            { from: 'e3', to: 'kalmoor', arrows: 'to' },
            { from: 'e1', to: 'e4', label: 'causes', arrows: 'to' },
            { from: 'e4', to: 'e5', label: 'causes', arrows: 'to' },
            { from: 'e4', to: 'verath', arrows: 'to', dashes: true },
            { from: 'e5', to: 'sunnaria', arrows: 'to', dashes: true },
          ]
        }
      ]
    };

    let network = null;
    let currentView = 'world';
    let cascadeStage = 0;

    const options = {
      autoResize: false,
      height: '100%',
      width: '100%',
      nodes: {
        font: { color: '#fff', size: 12 },
        borderWidth: 2,
        shadow: true,
      },
      edges: {
        font: { color: '#888', size: 10, align: 'middle' },
        color: { color: '#666', highlight: '#fff' },
        smooth: { type: 'cubicBezier' }
      },
      groups: {
        character: { color: { background: colors.character, border: '#c73e54' }, shape: 'ellipse' },
        place: { color: { background: colors.place, border: '#3d8a96' }, shape: 'ellipse' },
        event: { color: { background: colors.event, border: '#d4a106' }, shape: 'box' },
        group: { color: { background: colors.group, border: '#1e7b34' }, shape: 'box' },
        effect: { color: { background: colors.effect, border: '#cc5529' }, shape: 'box' },
      },
      physics: {
        barnesHut: { gravitationalConstant: -3000, springLength: 150 },
        stabilization: { iterations: 100 }
      },
      interaction: { hover: true }
    };

    function showView(view) {
      currentView = view;
      document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');

      const controlsDiv = document.getElementById('view-controls');

      switch(view) {
        case 'world':
          renderGraph(worldData);
          controlsDiv.innerHTML = '';
          updateInfo('world');
          break;
        case 'scene':
          renderGraph(sceneData);
          controlsDiv.innerHTML = '';
          updateInfo('scene');
          break;
        case 'pov':
          renderPOVGraph();
          controlsDiv.innerHTML = `
            <div class="pov-selector">
              <h2>Select POV Character</h2>
              <select onchange="changePOV(this.value)">
                <option value="reacher">Reacher (bodyguard)</option>
                <option value="elara">Queen Elara</option>
                <option value="aradia">Princess Aradia</option>
              </select>
            </div>
            <div id="pov-facts"></div>
          `;
          updatePOVFacts();
          break;
        case 'cascade':
          cascadeStage = 0;
          renderCascadeStage();
          controlsDiv.innerHTML = `
            <h2>Effect Cascade Stages</h2>
            <button class="btn" onclick="prevCascade()">← Previous</button>
            <button class="btn" onclick="nextCascade()">Next →</button>
            <div id="cascade-info"></div>
          `;
          updateCascadeInfo();
          break;
      }
    }

    function renderGraph(data) {
      const container = document.getElementById('graph');

      if (network) {
        network.destroy();
        network = null;
      }

      const nodes = new vis.DataSet(data.nodes);
      const edges = new vis.DataSet(data.edges);
      network = new vis.Network(container, { nodes, edges }, options);

      network.once('stabilized', function() {
        network.fit();
      });

      network.on('selectNode', function(params) {
        if (params.nodes.length > 0) {
          const nodeId = params.nodes[0];
          const node = data.nodes.find(n => n.id === nodeId);
          if (node) {
            const infoEl = document.getElementById('info');
            infoEl.innerHTML = `
              <h3>${node.label.replace(/\n/g, ' ')}</h3>
              <p>${node.title || 'No additional information'}</p>
              <p><code>ID: ${node.id}</code> | <code>Type: ${node.group}</code></p>
            `;
          }
        }
      });
    }

    function renderPOVGraph() {
      const nodes = [
        { id: 'pov', label: `POV:\n${currentPOV.charAt(0).toUpperCase() + currentPOV.slice(1)}`, group: 'character',
          color: { background: '#9b59b6', border: '#7d3c98' }, font: { size: 14 } },
      ];

      const edges = [];

      povData.facts.forEach(fact => {
        const known = fact.knownBy.includes(currentPOV);
        nodes.push({
          id: fact.id,
          label: fact.text,
          group: 'event',
          shape: 'box',
          font: { size: 10 },
          color: known
            ? { background: '#28a745', border: '#1e7b34' }
            : { background: '#444', border: '#333' },
          opacity: known ? 1 : 0.3
        });

        edges.push({
          from: 'pov',
          to: fact.id,
          color: known ? '#28a745' : '#e94560',
          dashes: !known,
          label: known ? 'knows' : 'hidden',
          arrows: 'to'
        });
      });

      renderGraph({ nodes, edges });
      updateInfo('pov');
    }

    function changePOV(pov) {
      currentPOV = pov;
      renderPOVGraph();
      updatePOVFacts();
    }

    function updatePOVFacts() {
      const div = document.getElementById('pov-facts');
      if (!div) return;

      const known = povData.facts.filter(f => f.knownBy.includes(currentPOV));
      const hidden = povData.facts.filter(f => !f.knownBy.includes(currentPOV));

      div.innerHTML = `
        <h2>Context Retrieved (${known.length})</h2>
        <div class="fact-list">
          ${known.map(f => `<div class="fact"><span class="fact-label">${f.type}</span><br>${f.text}</div>`).join('')}
        </div>
        <h2>Filtered Out (${hidden.length})</h2>
        <div class="fact-list">
          ${hidden.map(f => `<div class="fact hidden"><span class="fact-label">${f.type}</span><br>${f.text}</div>`).join('')}
        </div>
      `;
    }

    function renderCascadeStage() {
      const stage = cascadeData.stages[cascadeStage];
      renderGraph({ nodes: stage.nodes, edges: stage.edges });
    }

    function nextCascade() {
      if (cascadeStage < cascadeData.stages.length - 1) {
        cascadeStage++;
        renderCascadeStage();
        updateCascadeInfo();
      }
    }

    function prevCascade() {
      if (cascadeStage > 0) {
        cascadeStage--;
        renderCascadeStage();
        updateCascadeInfo();
      }
    }

    function updateCascadeInfo() {
      const stage = cascadeData.stages[cascadeStage];
      const div = document.getElementById('cascade-info');
      if (!div) return;

      const descriptions = [
        'The evil mage poisons the River Verath. This is the triggering event.',
        'System uses relationship data (flows-through) to identify affected kingdoms in order: Verath → Sunnaria → Kalmoor.',
        'System generates possible outcomes. Author selects Branch A (or rolls dice). Unselected branches fade.',
        'Selected effects become committed facts. Each kingdom gets appropriate severity. Secondary effects (economic collapse → refugees) cascade further.'
      ];

      div.innerHTML = `
        <div class="cascade-step ${cascadeStage === 3 ? 'committed' : ''}">
          <strong>Stage ${cascadeStage + 1}/4: ${stage.name}</strong>
          <p style="margin-top: 8px; font-size: 0.85em;">${descriptions[cascadeStage]}</p>
        </div>
      `;
    }

    function updateInfo(view) {
      const info = document.getElementById('info');

      const descriptions = {
        world: `
          <h3>World Graph</h3>
          <p>This shows entities and their relationships. <code>Characters</code> (red), <code>Places</code> (teal), and <code>Groups</code> (green) are connected by relationships.</p>
          <p>Key relationships: <code>rules</code>, <code>daughter-of</code>, <code>bodyguard-of</code>, <code>flows-through</code>, <code>member-of</code></p>
          <p>The dashed line shows Reacher's new appointment (recent fact).</p>
        `,
        scene: `
          <h3>Scene Structure</h3>
          <p>Events have <code>participants</code> (who was there) and <code>location</code>. Facts are <code>extracted</code> from the scene.</p>
          <p>Queen Elara is shown as "NOT present" - she won't know the scene details unless told.</p>
          <p>Extracted facts go to <strong>staging</strong> for review before committing to timeline.</p>
        `,
        pov: `
          <h3>POV Knowledge Filtering</h3>
          <p>Switch between characters to see what each one knows. <span style="color: #28a745">Green</span> = known, <span style="color: #e94560">Red/Dashed</span> = hidden from this POV.</p>
          <p>The LLM only receives <strong>green</strong> facts in context. It literally cannot reference hidden information.</p>
          <p>This is how epistemic isolation is enforced - by filtering at retrieval time.</p>
        `
      };

      info.innerHTML = descriptions[view] || '';
    }

    showView('world');
  </script>
</body>
</html>
